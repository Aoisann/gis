<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>My First MapLibre Map</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- 地域の説明を右下に移動・余白を小さく＋フィルター機能追加 -->
  <div id="region-legend" style="position:fixed;z-index:1000;bottom:10px;right:10px;background:rgba(255,255,255,0.95);padding:6px 10px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.12);font-size:15px;line-height:1.7;">
    <div style="margin-bottom:4px;font-size:14px;">地域で絞り込み：</div>
    <div id="region-filters" style="margin-bottom:6px; display: flex; flex-direction: column; gap: 8px;">
      <label style="display:flex;align-items:center;">
        <input type="checkbox" id="region-all" checked style="margin-right:4px;">
        全て表示
      </label>
      <label style="display:flex;align-items:center; margin-top:2px;">
        <input type="checkbox" class="region-checkbox" value="北米" checked style="margin-right:4px;">
        <img src="R-blue.png" style="width:20px;height:20px;vertical-align:middle;margin-right:2px;border-radius:50%;border:1px solid #fff;background:#fff;">
        北米
      </label>
      <label style="display:flex;align-items:center; margin-top:2px;">
        <input type="checkbox" class="region-checkbox" value="アジア" checked style="margin-right:4px;">
        <img src="R-purple.png" style="width:20px;height:20px;vertical-align:middle;margin-right:2px;border-radius:50%;border:1px solid #fff;background:#fff;">
        アジア
      </label>
      <label style="display:flex;align-items:center; margin-top:2px;">
        <input type="checkbox" class="region-checkbox" value="ヨーロッパ" checked style="margin-right:4px;">
        <img src="R-blue2.png" style="width:20px;height:20px;vertical-align:middle;margin-right:2px;border-radius:50%;border:1px solid #fff;background:#fff;">
        ヨーロッパ
      </label>
      <label style="display:flex;align-items:center; margin-top:2px;">
        <input type="checkbox" class="region-checkbox" value="オセアニア" checked style="margin-right:4px;">
        <img src="R-orenge.png" style="width:20px;height:20px;vertical-align:middle;margin-right:2px;border-radius:50%;border:1px solid #fff;background:#fff;">
        オセアニア
      </label>
    </div>
  </div>
  <!-- 大学名表示用エリア（左上） -->
  <div id="univ-name-display" style="position:fixed;top:10px;left:10px;z-index:2000;background:rgba(255,255,255,0.95);padding:10px 18px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.12);font-size:18px;min-width:180px;min-height:28px;"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        "version": 8,
        "sources": {
          "gsi-std": {
            "type": "raster",
            "tiles": [
              "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"
            ],
            "tileSize": 256,
            "attribution": "© 国土地理院"
          }
        },
        "layers": [
          {
            "id": "gsi-std-layer",
            "type": "raster",
            "source": "gsi-std",
            "minzoom": 0,
            "maxzoom": 18
          }
        ]
      },
      center: [139.9545, 35.8251],
      zoom: 1.8
    });

    // --- 麗澤大学のマーカー ---
    const reitakuIcon = document.createElement('img');
    reitakuIcon.src = 'R透過.png';
    reitakuIcon.style.width = '52px';
    reitakuIcon.style.height = '52px';
    new maplibregl.Marker({
        element: reitakuIcon,
        anchor: 'bottom'
    })
      .setLngLat([139.9545, 35.8251])
      .addTo(map);

    // --- 大学ピン表示 ---
    let allMarkers = [];
    fetch('大学ホームページ一覧_確定版.csv')
      .then(response => response.text())
      .then(csv => {
        function parseCSV(csv) {
          const lines = csv.trim().split('\n');
          const headers = lines[0].split(',');
          return lines.slice(1).map(line => {
            const cols = line.split(',');
            const obj = {};
            headers.forEach((h, i) => obj[h] = cols[i]);
            obj.lng = parseFloat(obj["経度"]);
            obj.lat = parseFloat(obj["緯度"]);
            return obj;
          });
        }

        const universityList = parseCSV(csv);

        const regionIcon = {
          "北米": "R-blue.png",
          "アジア": "R-purple.png",
          "ヨーロッパ": "R-blue2.png",
          "オセアニア": "R-orenge.png"
        };

        // ピンを地図に追加する関数
        function showMarkersByRegion(selectedRegions) {
          // 既存マーカーを全て削除
          allMarkers.forEach(m => m.remove());
          allMarkers = [];
          universityList.forEach(u => {
            if (selectedRegions.includes(u.region)) {
              let el = document.createElement('img');
              el.src = regionIcon[u.region];
              el.style.width = '40px';
              el.style.height = '40px';
              el.style.background = 'transparent';
              el.style.cursor = 'pointer';
              const marker = new maplibregl.Marker({ element: el, anchor: 'bottom' })
                .setLngLat([u.lng, u.lat])
                .setPopup(new maplibregl.Popup({ offset: 15 }).setHTML(
                  `<div style="font-size:13px;">${u.country ? u.country + ' ' : ''}${u.name}</div>`
                ))
                .addTo(map);
              el.addEventListener('click', function(e) {
                e.stopPropagation();
                marker.togglePopup();
              });
              allMarkers.push(marker);
            }
          });
        }

        // 初期表示（全てON）
        showMarkersByRegion(["北米", "アジア", "ヨーロッパ", "オセアニア"]);

        // チェックボックスでフィルター
        document.querySelectorAll('.region-checkbox').forEach(cb => {
          cb.addEventListener('change', () => {
            const selected = Array.from(document.querySelectorAll('.region-checkbox:checked')).map(e => e.value);
            showMarkersByRegion(selected);
          });
        });

        // 「全て表示」チェックボックスの制御
        const allBox = document.getElementById('region-all');
        const regionBoxes = document.querySelectorAll('.region-checkbox');

        // 「全て表示」クリック時
        allBox.addEventListener('change', () => {
          regionBoxes.forEach(cb => cb.checked = allBox.checked);
          const selected = Array.from(document.querySelectorAll('.region-checkbox:checked')).map(e => e.value);
          showMarkersByRegion(selected);
        });

        // 各地域チェックボックスクリック時
        regionBoxes.forEach(cb => {
          cb.addEventListener('change', () => {
            const checkedCount = Array.from(regionBoxes).filter(e => e.checked).length;
            allBox.checked = checkedCount === regionBoxes.length;
            const selected = Array.from(document.querySelectorAll('.region-checkbox:checked')).map(e => e.value);
            showMarkersByRegion(selected);
          });
        });
      });
  </script>
</body>
</html>