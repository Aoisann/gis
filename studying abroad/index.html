<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>My First MapLibre Map</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ベースマップ選択UI部分を修正 -->
  <div style="position:fixed;z-index:2000;top:10px;right:10px;background:rgba(255,255,255,0.95);padding:6px 12px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.12);font-size:15px;">
    <label for="basemap-select" style="font-size:14px;">ベースマップ：</label>
    <select id="basemap-select">
      <option value="gsi">国土地理院</option>
      <option value="carto" selected>White</option> <!-- ← ここをWhiteに -->
      <option value="dark">Dark Matter</option>
    </select>
  </div>
  <!-- 地域の説明・フィルターUIはここから下に続く -->
  <div id="region-legend" style="position:fixed;z-index:1000;bottom:10px;right:10px;background:rgba(255,255,255,0.95);padding:6px 10px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.12);font-size:15px;line-height:1.7;">
    <div style="margin-bottom:4px;font-size:14px;">地域で絞り込み：</div>
    <div id="region-filters" style="margin-bottom:6px; display: flex; flex-direction: column; gap: 8px;">
      <label style="display:flex;align-items:center;">
        <input type="checkbox" id="region-all" checked style="margin-right:4px;">
        全て表示
      </label>
      <label style="display:flex;align-items:center; margin-top:2px;">
        <input type="checkbox" class="region-checkbox" value="北米" checked style="margin-right:4px;">
        <img src="R-blue.png" style="width:20px;height:20px;vertical-align:middle;margin-right:2px;border-radius:50%;border:1px solid #fff;background:#fff;">
        北米
      </label>
      <label style="display:flex;align-items:center; margin-top:2px;">
        <input type="checkbox" class="region-checkbox" value="アジア" checked style="margin-right:4px;">
        <img src="R-purple.png" style="width:20px;height:20px;vertical-align:middle;margin-right:2px;border-radius:50%;border:1px solid #fff;background:#fff;">
        アジア
      </label>
      <label style="display:flex;align-items:center; margin-top:2px;">
        <input type="checkbox" class="region-checkbox" value="ヨーロッパ" checked style="margin-right:4px;">
        <img src="R-blue2.png" style="width:20px;height:20px;vertical-align:middle;margin-right:2px;border-radius:50%;border:1px solid #fff;background:#fff;">
        ヨーロッパ
      </label>
      <label style="display:flex;align-items:center; margin-top:2px;">
        <input type="checkbox" class="region-checkbox" value="オセアニア" checked style="margin-right:4px;">
        <img src="R-orenge.png" style="width:20px;height:20px;vertical-align:middle;margin-right:2px;border-radius:50%;border:1px solid #fff;background:#fff;">
        オセアニア
      </label>
    </div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    // ベースマップスタイル定義
    const baseStyles = {
      gsi: {
        "version": 8,
        "sources": {
          "gsi-std": {
            "type": "raster",
            "tiles": [
              "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"
            ],
            "tileSize": 256,
            "attribution": "© 国土地理院"
          }
        },
        "layers": [
          {
            "id": "gsi-std-layer",
            "type": "raster",
            "source": "gsi-std",
            "minzoom": 0,
            "maxzoom": 18
          }
        ]
      },
      carto: "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
      dark: "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json"
    };

    // --- 既存の初期値部分を修正 ---
    let map = new maplibregl.Map({
      container: 'map',
      style: baseStyles.carto, // ← 初期値をCartoDB Positronに
      center: [139.9545, 35.8251],
      zoom: 1.8
    });

    // --- 麗澤大学のマーカー ---
    const reitakuIcon = document.createElement('img');
    reitakuIcon.src = 'R透過.png';
    reitakuIcon.style.width = '52px';
    reitakuIcon.style.height = '52px';
    new maplibregl.Marker({
        element: reitakuIcon,
        anchor: 'bottom'
    })
      .setLngLat([139.9545, 35.8251])
      .addTo(map);

    // --- 大学ピン表示 ---
    let allMarkers = [];
    let universityList = [];
    const regionIcon = {
      "北米": "R-blue.png",
      "アジア": "R-purple.png",
      "ヨーロッパ": "R-blue2.png",
      "オセアニア": "R-orenge.png"
    };

    // ピンを地図に追加する関数
    function showMarkersByRegion(selectedRegions) {
      // 既存マーカーを全て削除
      allMarkers.forEach(m => m.remove());
      allMarkers = [];
      universityList.forEach(u => {
        if (selectedRegions.includes(u.region)) {
          let el = document.createElement('img');
          el.src = regionIcon[u.region];
          el.style.width = '40px';
          el.style.height = '40px';
          el.style.background = 'transparent';
          el.style.cursor = 'pointer';
          // ポップアップを削除
          const marker = new maplibregl.Marker({ element: el, anchor: 'bottom' })
            .setLngLat([u.lng, u.lat])
            .addTo(map);
          el.addEventListener('click', function(e) {
            e.stopPropagation();

            // すべての大学ピン画像のサイズと影を元に戻す
            document.querySelectorAll('.univ-marker-img').forEach(img => {
              img.style.width = '40px';
              img.style.height = '40px';
              img.style.zIndex = '';
              img.style.filter = '';
            });

            // この大学ピン画像だけ大きくし、地域ごとに影の色を変える
            el.style.width = '56px';
            el.style.height = '56px';
            el.style.zIndex = '10';
            if (u.region === "アジア" || u.region === "オセアニア") {
              el.style.filter = 'drop-shadow(0 0 6px #e91e63aa)'; // ピンク
            } else {
              el.style.filter = 'drop-shadow(0 0 6px #1976d2aa)'; // 青
            }

            // 左上に大学情報を表示
            let infoDiv = document.getElementById('univ-info');
            if (!infoDiv) {
              infoDiv = document.createElement('div');
              infoDiv.id = 'univ-info';
              infoDiv.style.position = 'fixed';
              infoDiv.style.top = '10px';
              infoDiv.style.left = '10px';
              infoDiv.style.zIndex = '2000';
              // ↓ここからスタイリッシュな背景
              infoDiv.style.background = 'linear-gradient(135deg, #f8fafc 60%, #e3e8ee 100%)';
              infoDiv.style.backdropFilter = 'blur(4px)';
              infoDiv.style.border = '1.5px solid #d1d5db';
              infoDiv.style.boxShadow = '0 4px 24px rgba(30,41,59,0.13)';
              infoDiv.style.padding = '18px 22px';
              infoDiv.style.borderRadius = '14px';
              infoDiv.style.fontSize = '16px';
              infoDiv.style.minWidth = '220px';
              infoDiv.style.maxWidth = '340px';
              infoDiv.style.transition = 'box-shadow 0.2s';
              document.body.appendChild(infoDiv);
            }

            // URL表示部分を削除
            infoDiv.innerHTML =
              `<div style="font-weight:bold;font-size:17px;margin-bottom:6px;">${u.name}</div>
               <div style="color:#555;margin-bottom:4px;">${u["english name"] ? u["english name"] : ""}</div>
               <div style="color:#888;margin-bottom:4px;">${u.country ? u.country : ""}</div>`;
            infoDiv.style.display = "block";
          });
          // マーカー画像生成時にクラスを付与
          el.classList.add('univ-marker-img');
          allMarkers.push(marker);
        }
      });
    }

    // CSV読み込みと初期ピン表示
    fetch('大学ホームページ一覧_確定版.csv')
      .then(response => response.text())
      .then(csv => {
        function parseCSV(csv) {
          const lines = csv.trim().split('\n');
          const headers = lines[0].split(',');
          return lines.slice(1).map(line => {
            const cols = line.split(',');
            const obj = {};
            headers.forEach((h, i) => obj[h] = cols[i]);
            obj.lng = parseFloat(obj["経度"]);
            obj.lat = parseFloat(obj["緯度"]);
            return obj;
          });
        }
        universityList = parseCSV(csv);
        showMarkersByRegion(["北米", "アジア", "ヨーロッパ", "オセアニア"]);
      });

    // フィルター制御
    const allBox = document.getElementById('region-all');
    const regionBoxes = document.querySelectorAll('.region-checkbox');

    // 「全て表示」クリック時
    allBox.addEventListener('change', () => {
      regionBoxes.forEach(cb => cb.checked = allBox.checked);
      const selected = Array.from(document.querySelectorAll('.region-checkbox:checked')).map(e => e.value);
      showMarkersByRegion(selected);
    });

    // 各地域チェックボックスクリック時
    regionBoxes.forEach(cb => {
      cb.addEventListener('change', () => {
        const checkedCount = Array.from(regionBoxes).filter(e => e.checked).length;
        allBox.checked = checkedCount === regionBoxes.length;
        const selected = Array.from(document.querySelectorAll('.region-checkbox:checked')).map(e => e.value);
        showMarkersByRegion(selected);
      });
    });

    // ベースマップ切替
    document.getElementById('basemap-select').addEventListener('change', function() {
      const val = this.value;
      // どのベースマップでも同じ中心・ズームにする
      map.setStyle(baseStyles[val]);
      map.setCenter([139.9545, 35.8251]);
      map.setZoom(1.8);

      // ベースマップ切替後もマーカーを再描画
      const selected = Array.from(document.querySelectorAll('.region-checkbox:checked')).map(e => e.value);
      map.once('style.load', () => {
        // 麗澤大学のマーカー再描画
        new maplibregl.Marker({
          element: reitakuIcon,
          anchor: 'bottom'
        })
          .setLngLat([139.9545, 35.8251])
          .addTo(map);
        showMarkersByRegion(selected);
      });
    });
  </script>
</body>
</html>